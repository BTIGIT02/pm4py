context("Conformance")

library(bupaR)

patrick::with_parameters_test_that("Alignment", {
  pm4py:::skip_if_no_pm4py()

  data("patients")

  
  ####  Update to pm4py df format ####
  patients_mapping <- bupaR::mapping(patients)
  
  patients["case:concept:name"] <- patients[patients_mapping$case_identifier]
  patients["concept:name"] <- patients[patients_mapping$activity_identifier]
  patients["time:timestamp"] <- patients[patients_mapping$timestamp_identifier]
  
  #### tamrof fd yp4mp ot etadpU ####
  
  
  net <- discovery_inductive(patients)

  # test two times for proper garbage collection
  res <- lapply(1:2, function(x) {
    a <- conformance_alignment(patients[1:10,],
                               net$petrinet,
                               net$initial_marking,
                               net$final_marking,
                               variant = variant,
                               convert = TRUE)
    numTraces <- n_cases(patients[1:10,])
    numAlignments <- length(unique(a$case_id))
    expect_equal(numAlignments, numTraces)
    return(a)
  })

  expect_length(res, 2)

}, patrick::cases(
    dijkstra = list(variant = variant_dijkstra_no_heuristics()),
    astar = list(variant = variant_state_equation_a_star()))
)
